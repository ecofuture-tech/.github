name: Update licenses (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.12'
      working-directory:
        description: 'Working directory for the package'
        required: false
        type: string
        default: '.'
      skip-license-generation:
        description: 'Skip third-party license generation'
        required: false
        type: boolean
        default: false
      skip-header-check:
        description: 'Skip license header check/addition'
        required: false
        type: boolean
        default: false
      copyright-holder:
        description: 'Copyright holder name'
        required: false
        type: string
        default: 'EcoFuture Technology Services LLC and contributors'
      copyright-year:
        description: 'Copyright year'
        required: false
        type: string
        default: '2026'
    secrets:
      WORKFLOW_LICENSE_TOKEN:
        description: 'Token for checkout and push'
        required: true

jobs:
  update-licenses:
    permissions:
      contents: write

    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.WORKFLOW_LICENSE_TOKEN }}
        persist-credentials: false
        fetch-depth: 0

    - name: Configure git
      run: git config core.autocrlf false

    - name: Extract package name from repository
      id: package
      run: |
        REPO_NAME="${GITHUB_REPOSITORY#*/}"
        echo "package_name=$REPO_NAME" >> $GITHUB_OUTPUT
        echo "✓ Package name: $REPO_NAME"

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Set up Python
      run: uv python install ${{ inputs.python-version }}

    - name: Set up Go (for addlicense)
      if: ${{ !inputs.skip-header-check }}
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install addlicense
      if: ${{ !inputs.skip-header-check }}
      run: |
        go install github.com/google/addlicense@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Install Python dependencies
      working-directory: ${{ inputs.working-directory }}
      run: |
        uv sync
        if [ "${{ inputs.skip-license-generation }}" = "false" ]; then
          uv pip install pip-licenses
        fi

    - name: Generate THIRD_PARTY_LICENSES.md
      if: ${{ !inputs.skip-license-generation }}
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "Generating third-party licenses..."
        uv run pip-licenses --format=markdown --ignore-packages ${{ steps.package.outputs.package_name }} --output-file=THIRD_PARTY_LICENSES.md
        
        if [ ! -s THIRD_PARTY_LICENSES.md ] || ! grep -q "Third-Party" THIRD_PARTY_LICENSES.md; then
          {
            echo "# Third-Party Licenses"
            echo ""
            echo "This document contains the licenses of all third-party dependencies used in this project."
            echo ""
            cat THIRD_PARTY_LICENSES.md
          } > THIRD_PARTY_LICENSES.md.tmp
          mv THIRD_PARTY_LICENSES.md.tmp THIRD_PARTY_LICENSES.md
        fi
        
        echo "✓ Generated THIRD_PARTY_LICENSES.md"

    - name: Add Apache 2.0 license headers
      if: ${{ !inputs.skip-header-check }}
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "Adding license headers to Python files..."
        
        addlicense \
          -c "${{ inputs.copyright-holder }}" \
          -l apache \
          -y "${{ inputs.copyright-year }}" \
          -ignore "venv/**" \
          -ignore ".venv/**" \
          -ignore ".tox/**" \
          -ignore "**/__pycache__/**" \
          -ignore "**/build/**" \
          -ignore "**/dist/**" \
          -ignore "**/*.egg-info/**" \
          .
        
        echo "✓ License headers processed"

    - name: Check for changes
      id: verify_changes
      working-directory: ${{ inputs.working-directory }}
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "✓ No changes needed"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "✓ Changes detected"
          git diff --stat
        fi

    - name: Commit and push changes
      if: steps.verify_changes.outputs.changed == 'true'
      working-directory: ${{ inputs.working-directory }}
      env:
        WORKFLOW_LICENSE_TOKEN: ${{ secrets.WORKFLOW_LICENSE_TOKEN }}
      run: |
        git config user.name "ecofuture-develop"
        git config user.email "ecofuture-develop@users.noreply.github.com"
        
        push_changes() {
          git push "https://x-access-token:${WORKFLOW_LICENSE_TOKEN}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}
        }
        
        licenses_file_changed() {
          [ -f "THIRD_PARTY_LICENSES.md" ] && ! git diff --quiet "THIRD_PARTY_LICENSES.md"
        }
        
        python_files_committed=false
        git add '**/*.py' 2>/dev/null || true
        
        if ! git diff --cached --quiet; then
          git commit -m "chore: update license headers [skip ci]"
          push_changes
          python_files_committed=true
          echo "✓ Python files committed and pushed"
        else
          echo "ℹ No Python file changes to commit"
        fi
        
        if [ "$python_files_committed" = true ]; then
          if licenses_file_changed; then
            git add THIRD_PARTY_LICENSES.md
            git commit -m "chore: update third-party licenses"
            echo "✓ THIRD_PARTY_LICENSES.md committed"
          else
            git commit --allow-empty -m "chore: license update workflow completed"
            echo "✓ Empty commit created to finalize workflow"
          fi
          push_changes
          echo "✓ Second commit pushed"
        elif licenses_file_changed; then
          git add THIRD_PARTY_LICENSES.md
          git commit -m "chore: update third-party licenses"
          push_changes
          echo "✓ THIRD_PARTY_LICENSES.md committed and pushed"
        fi
